#!/bin/bash

# Claude Pro/Maxãƒ­ã‚°ã‚¤ãƒ³ã‚’éå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹

set -e

# ã‚«ãƒ©ãƒ¼å®šç¾©
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}ğŸ” Claude Pro/Maxãƒ­ã‚°ã‚¤ãƒ³ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™${NC}"
echo ""

# æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
echo -e "${BLUE}æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ä¸­...${NC}"
claude logout >/dev/null 2>&1 || echo -e "${YELLOW}   ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¸ˆã¿ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰${NC}"

echo -e "${BLUE}Pro/Maxã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­...${NC}"
echo -e "${YELLOW}ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã¾ã™ã€‚Pro/Maxã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„${NC}"
echo -e "${YELLOW}ğŸ’¡ ${RED}APIè³‡æ ¼æƒ…å ±ã¯å…¥åŠ›ã—ãªã„${NC}ã§ãã ã•ã„${NC}"
echo -e "${YELLOW}ğŸ’¡ ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Œäº†ã‚’ç¢ºèªã—ã¦ãã ã•ã„${NC}"
echo ""

# éå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
# stdinã‚’åˆ‡ã£ã¦ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
# ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ã„ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
temp_script=$(mktemp)
cat > "$temp_script" << 'EOF'
#!/bin/bash
# éå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§claude loginã‚’å®Ÿè¡Œ
claude login </dev/null 2>&1
EOF
chmod +x "$temp_script"

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
(
  "$temp_script" &
  claude_login_pid=$!
  # 60ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹æ™‚é–“ã‚’ç¢ºä¿ï¼‰
  sleep 60
  # ãƒ—ãƒ­ã‚»ã‚¹ãŒã¾ã ç”Ÿãã¦ã„ã‚‹å ´åˆã¯çµ‚äº†
  if kill -0 $claude_login_pid 2>/dev/null; then
    kill -INT $claude_login_pid >/dev/null 2>&1 || true
  fi
  wait $claude_login_pid 2>/dev/null || true
  rm -f "$temp_script"
) &
login_pid=$!

echo -e "${BLUE}   ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Œäº†ã—ã¦ãã ã•ã„ï¼‰${NC}"
echo -e "${YELLOW}   ğŸ’¡ ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯è‡ªå‹•çš„ã«æˆ»ã‚Šã¾ã™ï¼ˆæœ€å¤§60ç§’ï¼‰${NC}"
echo ""

# ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤
wait $login_pid 2>/dev/null || true

echo ""
echo -e "${GREEN}âœ… Pro/Maxãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ${NC}"

# ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
echo -e "${BLUE}ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªä¸­...${NC}"
if claude whoami 2>&1 | grep -q -E "(masafumikikuchi|logged in|authenticated)"; then
  echo -e "${GREEN}âœ… Pro/Maxãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã—ãŸ${NC}"
  claude whoami
else
  echo -e "${YELLOW}âš ï¸  Pro/Maxãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒç¢ºèªã§ãã¾ã›ã‚“${NC}"
  echo -e "${YELLOW}   ğŸ’¡ æ‰‹å‹•ã§ 'claude login' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„${NC}"
fi

